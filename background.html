<html><head></head>
<body>
<canvas id="canvas" style="display: none"></canvas>
<script type="text/javascript">
var Bookmark = {
    current_url: '',

    Update: function(request) {
        console.log('-> Bookmark.Update');
        
        // Bookmark type
        Bookmark.icon.type = request.bookmark_icon;
        window.localStorage.setItem('toolbar_bookmark_icon', request.bookmark_icon);

        if (request.bookmark_url != Bookmark.current_url) {
            window.localStorage.removeItem('toolbar_bookmark_url');
            window.localStorage.setItem('toolbar_bookmark_url', request.bookmark_url);
            Bookmark.current_url = request.bookmark_url;
            Bookmark.icon.reset();
        } else {
            Bookmark.icon.load();
        }
    },

    icon: {

        type: window.localStorage.getItem('toolbar_bookmark_icon'),

        // this is default icon returned by google s2.
        def: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACsElEQVQ4jaWTzU8TARDFf7bdfuy228K2RQrdWiCIUTSSEirqwWiIXrh58WCICSc88YdwwoPhrge9qImJeFBi+FAoB4kKEfloEcJaSrttWdptwQs0GL35TjPJvDdvZjLwnzh1HFy5O+IScg7/1d5Id7lyMLSbM2K6vu8G8HichXqva84qWB7NTK3Pmt5SevrZsFETuHJ3xOUypdD59sBgoVDub4sqQbVVUcpmFbtgJaoqjI8v7qylMppXcrz8svxrzBCKm9PPhg0bgJBz+M9fDAwW9yr3LlwKhaMRBUm009XZTHGvTCQk06L6lYXFTeXJ0zn3ubYAC58rj4CUBSDeG+nOFUv9DwZ6wtGIAkDZrDIzv16bNaiICIKVgfs9Yb1Y6o/3RroBLABV82DoTLg+GL+s1gimWcU0q9R5RQCKRoVszqDO60JtqguaZnWoJpDJGbG+vg6laFT+2PDNa+3Ikg0AyWXjbGuQlWSGO7fPKZldIwZgA9B1w93gl5ElG5Jop7nRR3Ojr0YGsFpgO50HoMEvk9cNd80BgCTaAYh3nWFjK0vZ/NPNMQTBCsDhUW47vvNKMi03BlRkyUbf9TYmE0mWjopaVD+NAZEb8Sjp7D5LPzQ8Hmeh5kDxiXNvxxd3Tnbq7AihpQto6QIz82t8+rwJgN/n5NWrhZ16nzhXExDsp0ZXUxltMpH8p22An1tZqgcwmUiyuZ3XnIJlFMAKYLFfK0bCPu/0x7VI4LTsVUNeHHYLgiCgHS2usyPE0orG47GplOxxPE8kfr5Y//FatwKEum6Zu2nze9Np2T71cU2ZnU9ZnG6HmM3tsaXp6Pl93k8s77yb+L4uexzPvy3/GiuJxvbG1zeVv56pN67GStWDh5ldI5bP77sPDw/xeJwFf50063DZRic/rCZOPtN/4zedKxPebhBitwAAAABJRU5ErkJggg==",

        // it will try to load Icon from cache and if failed - will get icon from web
        load: function() {
            console.log('-> Bookmark.icon.load');
            var cached_icon = Bookmark.icon.cache;
            if (cached_icon) {
                if (cached_icon == Bookmark.icon.def || Bookmark.icon.type == 'default') {
                    // load our own default Girl Icon
                    chrome.browserAction.setIcon({path: 'icon_18.png'});
                } else {
                    chrome.browserAction.setIcon({path: cached_icon});
                }
            } else {
                Bookmark.icon.reset();
            }
        },

        get cache() {
            var res = window.localStorage.getItem('icon_cache');
            return (res)
                ? JSON.parse(res)
                : false;
        },
        
        set cache(data) {
            console.warn('storing cache');
            console.warn(data);
            if (data)
                window.localStorage.setItem('icon_cache', JSON.stringify(data));
        },

        reset: function(url) {
            console.log('-> Bookmark.icon.reset');
            if (!url) url = window.localStorage.getItem('toolbar_bookmark_url');
            var can = document.getElementById('canvas');
            var ctx = can.getContext('2d');
            var img = new Image();
            img.onload = function(){
                can.width = img.width;
                can.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);
                //var data = ctx.getImageData(0,0, img.width-1, img.height-1);
                //chrome.browserAction.setIcon({imageData: data});
                Bookmark.icon.cache = can.toDataURL("image/png");
                Bookmark.icon.load();
            }

            if (!url) url = '';
            if (url.match(/^http:\/\//)) url = url.replace(/^http:\/\//, '');
            var parts = url.split('/');
            img.src = 'http://s2.googleusercontent.com/s2/favicons?domain='+parts[0];
        }
    },
    
    Click: function() {
        console.log('-> Bookmark.Click');
        // should check for already opened settings here...
        var bookmark_url = window.localStorage.getItem('toolbar_bookmark_url');
        if (bookmark_url) {
            if (!bookmark_url.match(/^chrome:/) && !bookmark_url.match(/http:\/\//)) {
                bookmark_url = 'http://'+bookmark_url;
            }
            chrome.tabs.create({url: bookmark_url});
        } else {
            chrome.tabs.create({url: chrome.extension.getURL('settings.html')});
        }
    }
};

// add listener to communicate with settings page
chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) {
        console.log(request);
        if (request.action == 'reset_icon') {
            Bookmark.icon.reset();
        }
        if (request.action == 'save_bookmark') {
            Bookmark.Update(request);
        }
    }
);

// bind Iconv click event
chrome.browserAction.onClicked.addListener(function(tab){
    Bookmark.Click();
});

Bookmark.icon.load();
</script>
<!-- Written just for fun by Anton Kudris (aka jodaka) kudris@gmail.com -->
</body></html>
